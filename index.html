<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>

<div class="container">
    <div class="panel panel-warning">
        <div class="panel-heading">
        <h1></h1>
        </div>
        <div class="panel-body">
            <!--Content body hier! -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-striped" id="table_bots">
                    <thead>
                    <th>Bot</th>
                    <th>Speed</th>
                    <th>Distance</th>
                    <th>Driving time</th>
                    <th>Reconnect</th>
                    </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>


            <div class="row">

                <div class="col-md-8">
                    <input type="text" class="form-control" id="connectBot" placeholder="Groepnaam">
                </div>
                <div class="col-md-2">
                    <input type="button" class="btn btn-default" id="btnConnect" value="Connect bot" >
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 console">
                    <table id="console">

                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .console{
        background-color: #222222;
        margin-top:100px;
        height:300px;
        overflow-y: scroll;
        overflow-x:hidden;
        font-family:monospace;
        padding: 5px;
    }

    .console td{
        padding: 5px;
        color: limegreen;
    }
</style>

<script>

    var socket = io.connect('http://localhost:8080');
    var testBot = '{"speed":"300","time":"3000","mac":"80DAD343QRE","distance":"150","name":"bot17"}';
    var latestUpdate = new Array();
    //  addOrUpdateBot(testBot);

    function timeoutTimer(){
        for (var i in latestUpdate){
            if (typeof latestUpdate[i] !== 'function') {
                if(Date.now() - latestUpdate[i] > 5000){
                    $('#table_bots > tbody > tr[mac="'+i+'"]').addClass('danger');
                    $('#table_bots > tbody > tr[mac="'+i+'"]').attr('disabled',true);
                    $('#table_bots > tbody > tr[mac="'+i+'"]').find("td").eq(4).find('button').fadeIn();
                }else{
                    $('#table_bots > tbody > tr[mac="'+i+'"]').removeClass('danger');
                    $('#table_bots > tbody > tr[mac="'+i+'"]').attr('disabled',false);
                    $('#table_bots > tbody > tr[mac="'+i+'"]').find("td").eq(4).find('button').fadeOut();

                }
            }
        }
    };

    setInterval(timeoutTimer, 1000);
    socket.on('connected', function (data) {
          $("h1").html('Connection established')
    });

    socket.on('update_bot', function(data){
        addOrUpdateBot(data);
    });

    socket.on('disconnect', function(data){
          $("h1").html(data)
    });

    socket.on('console_message', function(data){
        $('#console').append("<tr><td>> " + data + "</td></tr>")
        $(".console").stop().animate({ scrollTop: $(".console")[0].scrollHeight}, 1000);
    });

    // als verbinden failed (server kant) dan moet er een event gestuurd worden naar de client dat het niet is gelukt en de knop weer enabled moet / text updaten van de knop

    socket.on('connection_failed', function(data){
        var jsonobj = $.parseJSON(data);
        $("button#" + jsonobj.mac).html("Opniew verbinden");
        $("button#" + jsonobj.mac).attr("disabled", false);
    });

    $(document).ready(function(){
        $("#btnConnect").click(function(){
            reconnect($("#connectBot").val(), null);
        });
    });

    function close(){
        socket.emit("close", "");
        console.info("Close command send...")
    }

    function search(){
        socket.emit("search", "");
        console.info("Search command send...")
    }
    function reconnect(name, mac){
        socket.emit("reconnectEvent", name);
        if(mac){
            $("button#" +mac).html("Verbinden...");
            $("button#" +mac).attr("disabled", true);
        }
    }

    function addOrUpdateBot(jsonString){
        var jsonobj = $.parseJSON(jsonString)
        var alreadyExist = false;

        // Searching for existing row with this mac
        $('#table_bots > tbody  > tr').each(function() {
            if($(this).attr("mac") == jsonobj.mac){
                $(this).find("td").eq(1).html(jsonobj.speed);
                $(this).find("td").eq(2).html(jsonobj.distance);
                $(this).find("td").eq(3).html(jsonobj.time);
                $("button#" +jsonobj.mac).html("Opnieuw verbinden");
                $("button#" +jsonobj.mac).attr("disabled", false);
                alreadyExist = true;
                latestUpdate[jsonobj.mac] = Date.now();
            }
        });

        //console.info(alreadyExist);
        // Bot did not yet exist... creating new row
        if(!alreadyExist){
            //console.info('<tr mac="' + jsonobj.mac + '"><td>' + jsonobj.name + '</td><td>' + jsonobj.speed + '</td><td>' + jsonobj.distance + '</td><td>' + jsonobj.time + '</td></tr>');
            $('#table_bots > tbody').append('<tr mac="' + jsonobj.mac + '"><td>' + jsonobj.name + '</td><td>' + jsonobj.speed + '</td><td>' + jsonobj.distance + '</td><td>' + jsonobj.time + '</td><td> <button class="btn btn-info" id=\''+ jsonobj.mac + '\' onclick="reconnect(\''+ jsonobj.name +'\', this.id)">Opnieuw verbinden</button></td></tr>');
            latestUpdate[jsonobj.mac] = Date.now();
        }
    }


</script>

</body>
</html>